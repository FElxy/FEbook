# 缓存概览

## 作用

重用已获取的资源，减少延迟与网络阻塞，进而减少显示某个资源所用的时间

```
|-数据库缓存
|-服务器缓存
|--|- 代理服务器缓存
|--|- CDN缓存
|-浏览器缓存---
。。。
```

## 应用场景

* 重复加载静态资源，使用协商缓存（304）让浏览器使用本地缓存

* 强制使用本地缓存（200），不用与服务器通信
* 请求加ETag，文件加hash来判断缓存是否更新
* 静态资源放CDN
* 资源文件用依赖文件摘要的方式命名，内容有修改变成新文件，不影响已有的文件。上线全量部署静态资源，再灰度部署页面

## 缓存技术

### cookie

容量小（4k），不安全（cookie被拦截，可能暴露session），需要自己封装接口，需指定作用域，不能跨域调用

### web Storage

容量（5M），localstorage可做持久化数据存储

支持事件通知机制，可以将数据更新的通知发送给监听者

本地数据容易被篡改，容易受到XSS攻击

缓存读取需要依靠js的执行，所以前提条件就是能够读取到html及js代码段，其次文件的版本更新控制会带来更多的代码层面的维护成本，所以LocalStorage更适合关键的业务数据而非静态资源

Cookie的作用是与服务器进行交互，作为HTTP规范的一部分而存在 ，而Web Storage仅仅是为了在本地“存储”数据而生

### indexDB

IndexedDb提供了一个结构化的、事务型的、高性能的NoSQL类型的数据库，包含了一组同步/异步API

### PWA(Service Worker)

作为一个独立的线程，是一段在后台运行的脚本，可使web app也具有类似原生App的离线使用、消息推送、后台自动更新等能力

- 不能访问 DOM
- 不能使用同步 API
- 需要HTTPS协议



### 实践

#### 1、大公司静态资源优化方案

- 配置超长时间的本地缓存 —— 节省带宽，提高性能
- 采用内容摘要作为缓存更新依据 —— 精确的缓存控制
- 静态资源CDN部署 —— 优化网络请求
- 更资源发布路径实现非覆盖式发布 —— 平滑升级

#### 2、利用浏览器缓存机制

- 对于某些不需要缓存的资源，可以使用 Cache-control: no-store ，表示该资源不需要缓存
- 对于频繁变动的资源（比如经常需要刷新的首页，资讯论坛新闻类），可以使用 Cache-Control: no-cache 并配合 ETag 使用，表示该资源已被缓存，但是每次都会发送请求询问资源是否更新。
- 对于代码文件来说，通常使用 Cache-Control: max-age=31536000 并配合策略缓存使用，然后对文件进行指纹处理，一旦文件名变动就会立刻下载新的文件。

#### 3、静态资源文件通过Service Worker进行缓存控制和离线化加载